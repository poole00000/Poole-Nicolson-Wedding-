<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Christopher & Halifax Wedding Address Request</title>
  <meta name="description" content="Share your mailing address so Christopher Poole & Halifax Nicolson can send wedding invitations!" />
  <style>
    :root{
      --vt-green:#0b5d1e; --vt-green-dark:#084819; --vt-rail:#0f6e2a;
      --paper:#ffffff; --ink:#0a0a0a; --ring:rgba(11,93,30,.25); --panel:#f8fff9;
    }
    html,body{height:100%;margin:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; color:var(--ink);
      background: radial-gradient(1200px 600px at 20% -10%, rgba(11,93,30,.15), transparent),
                  radial-gradient(900px 500px at 100% 10%, rgba(19,94,53,.12), transparent),
                  linear-gradient(180deg,#e9f3ec 0%,#e0efe6 100%);
    }
    .wrap{max-width:880px;margin:0 auto;padding:40px 16px;}
    .plate{
      background:var(--vt-green); color:var(--paper); border-radius:18px;
      box-shadow:0 18px 40px rgba(0,0,0,.18), inset 0 0 0 6px var(--vt-green-dark), inset 0 0 0 10px var(--vt-rail);
      overflow:hidden; position:relative;
    }
    .plate::before,.plate::after{content:""; position:absolute; left:0; right:0; height:14px; background:linear-gradient(180deg,#09712a,#0b5d1e)}
    .plate::before{top:0} .plate::after{bottom:0}
    header{text-align:center; padding:26px 24px 0 24px; position:relative;}
    header .eyebrow{letter-spacing:.18em; text-transform:uppercase; font-size:12px; opacity:.95}
    header h1{margin:10px 0 6px 0; font-weight:800; font-size:clamp(26px,4vw,36px); letter-spacing:.02em}
    header p{margin:0 0 10px 0; font-size:14px; opacity:.9}
    .mountains{width:100%; height:70px; display:block;}
    .section{padding:0 18px 20px 18px;}
    .section + .section{padding-top:8px;}
    .fieldbox{
      background:var(--panel); border-radius:12px; padding:16px;
      box-shadow:inset 0 0 0 2px #cfe8d6, inset 0 2px 6px rgba(0,0,0,.06); color:#0c3a1a;
    }
    .legend{display:flex; align-items:center; gap:.5rem; font-weight:800; color:#0c3a1a; margin:2px 0 10px 0; font-size:15px; text-transform:uppercase; letter-spacing:.06em}
    .grid{display:grid; gap:14px}
    @media(min-width:720px){ .grid.cols-2{grid-template-columns:1fr 1fr} .grid.cols-3{grid-template-columns:1fr 1fr 1fr} }
    label{font-size:13px; color:#0c3a1a; font-weight:800; text-transform:uppercase; letter-spacing:.04em}
    .req:after{content:"*"; color:#fefefe; background:#0d7e2e; border-radius:6px; padding:0 6px; margin-left:6px}
    input,select,textarea{
      width:100%; box-sizing:border-box; margin-top:6px; border-radius:10px; border:1px solid #9bd0a8;
      padding:10px 12px; font-size:15px; background:#fff; color:#10351f; outline:none; transition:box-shadow .15s, border-color .15s;
    }
    input:focus,select:focus,textarea:focus{border-color:var(--vt-green); box-shadow:0 0 0 4px var(--ring)}
    .row{display:flex; align-items:center; gap:10px}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
      padding:12px 18px; border-radius:12px; border:2px solid #e7f5ea; background:var(--paper); color:var(--vt-green);
      font-weight:800; text-transform:uppercase; letter-spacing:.06em; box-shadow:0 8px 18px rgba(11,93,30,.25); cursor:pointer;
    }
    .btn:hover{background:#f5fff7; border-color:#fff}
    .banner{display:none; margin:0 18px 16px 18px; border-radius:10px; background:#e9f7ec; color:#0e5a2a; border:1px solid #c6e6cf; padding:12px 14px;}
    footer{text-align:center; color:#e6f7ea; font-size:12px; padding:10px 18px 22px 18px}

    /* Household members repeater */
    .member-row{display:grid; grid-template-columns:1fr 1fr auto; gap:12px; align-items:end}
    .remove-member{border:1px solid #d3e9d8; background:#fff; color:#0b5d1e; border-radius:10px; padding:9px 12px; cursor:pointer}
    .remove-member:hover{background:#f5fff7}
    .hint{font-size:12px; color:#0d4e25; opacity:.9; margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="plate">
      <header>
        <div class="eyebrow">Christopher Poole & Halifax Nicolson</div>
        <h1>We'd love your mailing address</h1>
        <p>Help us send wedding invitations. Takes ~60 seconds. Thank you!</p>
        <svg class="mountains" viewBox="0 0 600 80" preserveAspectRatio="none" aria-hidden="true">
          <path d="M0,80 L80,30 130,60 180,40 230,70 300,20 360,60 420,35 500,75 600,50 600,80 Z" fill="#0d7e2e"></path>
          <path d="M0,80 L60,45 120,65 170,35 220,60 280,25 340,55 410,28 480,68 540,40 600,60 600,80 Z" fill="#084819" opacity=".9"></path>
        </svg>
      </header>

      <div id="successBanner" class="banner">Thanks! Your address was recorded. You can add another, or close this page.</div>

      <form id="addressForm" class="section" novalidate>
        <div class="fieldbox">
          <div class="legend">Names</div>
          <div class="grid cols-2">
            <div>
              <label class="req">First name</label>
              <input name="firstName" autocomplete="given-name" required type="text" />
            </div>
            <div>
              <label class="req">Last name</label>
              <input name="lastName" autocomplete="family-name" required type="text" />
            </div>
          </div>
          <div style="margin-top:12px">
            <label>Household / Envelope name</label>
            <input name="household" type="text" placeholder="e.g., Chuck & Dianne Norris" />
          </div>
        </div>

        <!-- NEW: Household members -->
        <div class="fieldbox" style="margin-top:16px">
          <div class="legend">Household members (optional)</div>
          <div id="membersList" class="grid" style="gap:12px"></div>
          <div class="row" style="margin-top:8px">
            <button id="btnAddMember" type="button" class="btn">+ Add person</button>
          </div>
          <p class="hint">Add everyone you want listed on the envelope. We’ll still use the address below for mailing.</p>
        </div>

        <div class="fieldbox" style="margin-top:16px">
          <div class="legend">Address</div>
          <div>
            <label class="req">Address line 1</label>
            <input name="address1" autocomplete="address-line1" required type="text" />
          </div>
          <div>
            <label>Address line 2</label>
            <input name="address2" autocomplete="address-line2" type="text" />
          </div>
          <div class="grid cols-3">
            <div>
              <label class="req">City</label>
              <input name="city" autocomplete="address-level2" required type="text" />
            </div>
            <div>
              <label class="req">State / Province</label>
              <input name="state" autocomplete="address-level1" required type="text" />
            </div>
            <div>
              <label class="req">ZIP / Postal code</label>
              <input name="postal" autocomplete="postal-code" required type="text" />
            </div>
          </div>
          <div style="margin-top:12px">
            <label class="req">Country</label>
            <select name="country" required>
              <option value="United States" selected>United States</option>
              <option>Canada</option>
              <option>United Kingdom</option>
              <option>Australia</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div class="fieldbox" style="margin-top:16px">
          <div class="legend">Contact</div>
          <div class="grid cols-2">
            <div>
              <label>Email</label>
              <input name="email" autocomplete="email" type="email" />
            </div>
            <div>
              <label>Phone (optional)</label>
              <input name="phone" autocomplete="tel" type="tel" />
            </div>
          </div>
          <div style="margin-top:12px">
            <label>Notes for the couple</label>
            <textarea name="notes" rows="3" placeholder="Anything we should know about mailing to you?"></textarea>
          </div>
          <div class="row" style="margin-top:10px">
            <input id="consent" name="consent" type="checkbox" />
            <label for="consent">I consent to sharing this info for wedding invitations and related updates.</label>
          </div>
        </div>

        <div class="row" style="padding:14px 2px 18px 2px">
          <button type="submit" class="btn">Submit address</button>
          <button id="addAnother" type="button" class="btn" style="display:none">Add another</button>
        </div>
      </form>

      <footer>Christopher & Halifax • Vermont</footer>
    </div>
  </div>

  <script>
    /* Your deployed Web App URL (ends with /exec) */
    const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbzGR1HD37hzxzywX0dQlM8kXvUNKQ_og0wGnVcka0It-Sj5z_oSW2KJID0-kK0yB-kY-g/exec';

    const STORAGE_KEY = 'wedding-address-submissions:v4';
    const form = document.getElementById('addressForm');
    const successBanner = document.getElementById('successBanner');
    const addAnotherBtn = document.getElementById('addAnother');
    const membersList = document.getElementById('membersList');
    const btnAddMember = document.getElementById('btnAddMember');

    function loadLocal(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }catch{ return []; } }
    function saveLocal(rows){ localStorage.setItem(STORAGE_KEY, JSON.stringify(rows)); }

    function addMemberRow(first='', last=''){
      const row = document.createElement('div');
      row.className = 'member-row';
      row.innerHTML = `
        <div>
          <label>First name</label>
          <input type="text" class="m-first" value="${first.replace(/"/g,'&quot;')}"/>
        </div>
        <div>
          <label>Last name</label>
          <input type="text" class="m-last" value="${last.replace(/"/g,'&quot;')}"/>
        </div>
        <div>
          <button type="button" class="remove-member" aria-label="Remove person">Remove</button>
        </div>
      `;
      row.querySelector('.remove-member').addEventListener('click', ()=> row.remove());
      membersList.appendChild(row);
    }

    function gatherMembers(){
      const items = [];
      membersList.querySelectorAll('.member-row').forEach(r=>{
        const first = (r.querySelector('.m-first')?.value || '').trim();
        const last  = (r.querySelector('.m-last')?.value  || '').trim();
        if(first || last) items.push({first, last});
      });
      return items;
    }

    btnAddMember.addEventListener('click', ()=> addMemberRow());
    // start with one empty row for convenience
    addMemberRow();

    function toRow(d, peopleJoined){
      return [
        new Date().toISOString(),
        d.firstName||'', d.lastName||'', d.household||'',
        d.address1||'', d.address2||'', d.city||'',
        d.state||'', d.postal||'', d.country||'',
        d.email||'', d.phone||'', d.notes||'',
        peopleJoined,                       // NEW: People
        d.consent ? 'Yes' : 'No'
      ];
    }

    function formToObject(fd){
      const obj = {}; for(const [k,v] of fd.entries()) obj[k] = (v||'').toString().trim();
      obj.consent = document.getElementById('consent').checked;
      // Build people array: include primary + any members
      const members = gatherMembers();
      const primaryName = ((obj.firstName||'') + ' ' + (obj.lastName||'')).trim();
      if(primaryName) members.unshift({first: obj.firstName||'', last: obj.lastName||''});
      obj.people = JSON.stringify(members);
      obj.peopleJoined = members.map(p => (p.first||'') + ' ' + (p.last||'')).map(s=>s.trim()).filter(Boolean).join('; ');
      return obj;
    }

    async function postToEndpoint(payload){
      if(!ENDPOINT_URL) return { ok:false, skipped:true };
      try{
        // Send as form-encoded (Apps Script reads via e.parameter)
        const body = new URLSearchParams(payload).toString();
        const res = await fetch(ENDPOINT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body
        });
        let data = null;
        try { data = await res.json(); } catch { data = { ok: res.ok }; }
        return data;
      }catch(err){
        console.warn('Endpoint post failed:', err);
        return { ok:false, error:String(err) };
      }
    }

    function clearForm(){
      form.reset();
      document.getElementById('consent').checked = false;
      membersList.innerHTML = '';
      addMemberRow();
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(form);
      const required = ['firstName','lastName','address1','city','state','postal','country'];
      for(const k of required){ if(!fd.get(k) || !String(fd.get(k)).trim()){ alert('Please complete all required fields.'); return; } }

      const payload = formToObject(fd);
      const rows = loadLocal();
      rows.push(toRow(payload, payload.peopleJoined));
      saveLocal(rows);

      const r = await postToEndpoint(payload);
      if(!r.ok && !r.skipped){
        console.warn('Saved locally; could not reach Sheets right now.');
      }

      successBanner.style.display = 'block';
      addAnotherBtn.style.display = 'inline-flex';
      clearForm();
      addAnotherBtn.scrollIntoView({behavior:'smooth', block:'center'});
    });

    addAnotherBtn.addEventListener('click', ()=>{
      successBanner.style.display = 'none';
      addAnotherBtn.style.display = 'none';
      form.scrollIntoView({behavior:'smooth', block:'start'});
    });
  </script>
</body>
</html>
